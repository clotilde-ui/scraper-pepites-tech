<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scraper Les P√©pites Tech</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f5f7fa; }
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,.08); }
        #results-table { font-size: .9rem; }
        .badge-tag { margin: 1px; }
        .progress { height: 24px; }
    </style>
</head>
<body>
<div class="container py-4">
    <!-- Navigation entre les outils -->
    <nav class="mb-3">
        <a href="/chefs-etablissement" class="btn btn-outline-secondary btn-sm">
            Chefs d'√©tablissement (lyc√©es &amp; coll√®ges publics)
        </a>
    </nav>

    <h1 class="mb-1">Scraper Les P√©pites Tech</h1>
    <p class="text-muted mb-4">Extraire les startups list√©es sur lespepitestech.com</p>

    <!-- Controls -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="scrape-form" class="row g-3 align-items-end">
                <div class="col-auto">
                    <label for="category" class="form-label">Cat√©gorie</label>
                    <select id="category" class="form-select" style="min-width:260px">
                        <option value="">Toutes les collections</option>
                        {% for slug, info in categories.items() %}
                        <option value="{{ slug }}">{{ info.name }}{% if info.count %} ({{ info.count }}){% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <label for="num-pages" class="form-label">Nombre de pages</label>
                    <div class="input-group" style="width:200px">
                        <input type="number" id="num-pages" class="form-control" value="3" min="0" max="100">
                        <span class="input-group-text" style="font-size:.75rem" title="0 = scraper toutes les pages">0 = toutes</span>
                    </div>
                </div>
                <div class="col-auto pt-2">
                    <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox" id="with-details">
                        <label class="form-check-label" for="with-details">
                            Scraping complet (pages d√©tail)
                        </label>
                    </div>
                </div>
                <div class="col-auto">
                    <button type="submit" id="btn-scrape" class="btn btn-primary mt-2">
                        Lancer le scraping
                    </button>
                </div>
            </form>

            <!-- Progress -->
            <div id="progress-section" class="mt-3 d-none">
                <div class="progress mb-2">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width:0%">0%</div>
                </div>
                <small id="progress-msg" class="text-muted"></small>
            </div>
        </div>
    </div>

    <!-- Export buttons -->
    <div id="export-section" class="mb-3 d-none">
        <span class="me-2 fw-semibold" id="result-count"></span>
        <a href="/api/export/csv" class="btn btn-success btn-sm me-1">Export CSV</a>
        <a href="/api/export/excel" class="btn btn-success btn-sm">Export Excel</a>
    </div>

    <!-- Results table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="results-table">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Nom</th>
                        <th>Description</th>
                        <th>Cat√©gories</th>
                        <th>Votes</th>
                        <th>Localisation</th>
                        <th>Fondateur</th>
                        <th>Liens</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                    <tr><td colspan="8" class="text-center text-muted py-4">Aucune donn√©e. Lancez un scraping pour commencer.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
const form = document.getElementById('scrape-form');
const btnScrape = document.getElementById('btn-scrape');
const progressSection = document.getElementById('progress-section');
const progressBar = document.getElementById('progress-bar');
const progressMsg = document.getElementById('progress-msg');
const exportSection = document.getElementById('export-section');
const resultCount = document.getElementById('result-count');
const resultsBody = document.getElementById('results-body');

let pollInterval = null;

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const numPages = parseInt(document.getElementById('num-pages').value) || 3;
    const withDetails = document.getElementById('with-details').checked;
    const category = document.getElementById('category').value;

    btnScrape.disabled = true;
    btnScrape.textContent = 'Scraping en cours...';
    progressSection.classList.remove('d-none');
    exportSection.classList.add('d-none');
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';

    try {
        const resp = await fetch('/api/scrape', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({num_pages: numPages, with_details: withDetails, category: category})
        });
        if (!resp.ok) {
            const err = await resp.json();
            alert(err.error || 'Erreur');
            btnScrape.disabled = false;
            btnScrape.textContent = 'Lancer le scraping';
            return;
        }
    } catch (err) {
        alert('Erreur r√©seau : ' + err);
        btnScrape.disabled = false;
        btnScrape.textContent = 'Lancer le scraping';
        return;
    }

    // Poll progress
    pollInterval = setInterval(async () => {
        try {
            const resp = await fetch('/api/progress');
            const data = await resp.json();

            const pct = data.total > 0 ? Math.round((data.progress / data.total) * 100) : 0;
            progressBar.style.width = pct + '%';
            progressBar.textContent = pct + '%';
            progressMsg.textContent = data.message;

            if (!data.running) {
                clearInterval(pollInterval);
                btnScrape.disabled = false;
                btnScrape.textContent = 'Lancer le scraping';
                progressBar.classList.remove('progress-bar-animated');
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';

                // Load results
                loadResults();
            }
        } catch (err) {
            console.error(err);
        }
    }, 800);
});

async function loadResults() {
    const resp = await fetch('/api/results');
    const data = await resp.json();

    if (data.length === 0) {
        resultsBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">Aucun r√©sultat trouv√©.</td></tr>';
        exportSection.classList.add('d-none');
        return;
    }

    resultCount.textContent = data.length + ' startups trouv√©es';
    exportSection.classList.remove('d-none');

    resultsBody.innerHTML = data.map((s, i) => {
        const links = [];
        if (s.site_web) links.push(`<a href="${esc(s.site_web)}" target="_blank" title="Site web">üåê</a>`);
        if (s.twitter) links.push(`<a href="${esc(s.twitter)}" target="_blank" title="Twitter">üê¶</a>`);
        if (s.linkedin) links.push(`<a href="${esc(s.linkedin)}" target="_blank" title="LinkedIn">üíº</a>`);

        const tags = s.categories ? s.categories.split(', ').map(t =>
            `<span class="badge bg-secondary badge-tag">${esc(t)}</span>`
        ).join(' ') : '';

        return `<tr>
            <td>${i + 1}</td>
            <td class="fw-semibold">${esc(s.nom)}</td>
            <td style="max-width:250px">${esc(s.description)}</td>
            <td>${tags}</td>
            <td>${s.votes}</td>
            <td>${esc(s.localisation)}</td>
            <td>${esc(s.fondateur)}</td>
            <td class="text-nowrap">${links.join(' ')}</td>
        </tr>`;
    }).join('');
}

function esc(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}
</script>
</body>
</html>
